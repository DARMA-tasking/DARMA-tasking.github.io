<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DARMA &raquo; Introduction &raquo; Virtual Context Collection | vt (Virtual Transport)</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,400i,600,600i%7CSource+Code+Pro:400,400i,600" />
  <link rel="stylesheet" href="m-dark+documentation.compiled.css" />
  <link rel="icon" href="favicon-dark.png" type="image/png" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#22272e" />
</head>
<body>
<header><nav id="navigation">
  <div class="m-container">
    <div class="m-row">
      <a href="index.html" id="m-navbar-brand" class="m-col-t-8 m-col-m-none m-left-m">vt <span class="m-thin">(Virtual Transport)</span></a>
      <div class="m-col-t-4 m-hide-m m-text-right m-nopadr">
        <a href="#search" class="m-doc-search-icon" title="Search" onclick="return showSearch()"><svg style="height: 0.9rem;" viewBox="0 0 16 16">
          <path id="m-doc-search-icon-path" d="m6 0c-3.31 0-6 2.69-6 6 0 3.31 2.69 6 6 6 1.49 0 2.85-0.541 3.89-1.44-0.0164 0.338 0.147 0.759 0.5 1.15l3.22 3.79c0.552 0.614 1.45 0.665 2 0.115 0.55-0.55 0.499-1.45-0.115-2l-3.79-3.22c-0.392-0.353-0.812-0.515-1.15-0.5 0.895-1.05 1.44-2.41 1.44-3.89 0-3.31-2.69-6-6-6zm0 1.56a4.44 4.44 0 0 1 4.44 4.44 4.44 4.44 0 0 1-4.44 4.44 4.44 4.44 0 0 1-4.44-4.44 4.44 4.44 0 0 1 4.44-4.44z"/>
        </svg></a>
        <a id="m-navbar-show" href="#navigation" title="Show navigation"></a>
        <a id="m-navbar-hide" href="#" title="Hide navigation"></a>
      </div>
      <div id="m-navbar-collapse" class="m-col-t-12 m-show-m m-col-m-none m-right-m">
        <div class="m-row">
          <ol class="m-col-t-6 m-col-m-none">
            <li>
              <a href="introduction.html">Introduction</a>
              <ol>
                <li><a href="context.html">Context</a></li>
                <li><a href="active-messenger.html">Active Messenger</a></li>
                <li><a href="collection.html" id="m-navbar-current">Virtual Context Collection</a></li>
                <li><a href="collective.html">Collectives</a></li>
                <li><a href="group.html">Group Manager</a></li>
                <li><a href="location.html">Location Manager</a></li>
                <li><a href="objgroup.html">Object Group Manager</a></li>
                <li><a href="pipe.html">Pipe Manager</a></li>
                <li><a href="pool.html">Memory Pool</a></li>
                <li><a href="rdmahandle.html">RDMA Handle Manager</a></li>
                <li><a href="registry.html">Registry</a></li>
                <li><a href="scheduler.html">Scheduler</a></li>
                <li><a href="term.html">Termination Detector</a></li>
                <li><a href="trace.html">Tracing</a></li>
              </ol>
            </li>
            <li>
              <a href="learn.html">Learn</a>
              <ol>
                <li><a href="vt-build.html">How to Build</a></li>
                <li><a href="tutorial.html">Tutorial</a></li>
                <li><a href="examples.html">Examples</a></li>
              </ol>
            </li>
            <li><a href="pages.html">Pages</a></li>
            <li>
              <a href="namespaces.html">Namespaces</a>
              <ol>
                <li><a href="namespacevt.html">vt</a></li>
                <li><a href="namespacevt_1_1collective.html">vt::collective</a></li>
                <li><a href="namespacevt_1_1debug.html">vt::debug</a></li>
                <li><a href="namespacevt_1_1group.html">vt::group</a></li>
                <li><a href="namespacevt_1_1location.html">vt::location</a></li>
                <li><a href="namespacevt_1_1messaging.html">vt::messaging</a></li>
                <li><a href="namespacevt_1_1objgroup.html">vt::objgroup</a></li>
                <li><a href="namespacevt_1_1pipe.html">vt::pipe</a></li>
                <li><a href="namespacevt_1_1rdma.html">vt::rdma</a></li>
                <li><a href="namespacevt_1_1runtime.html">vt::runtime</a></li>
                <li><a href="namespacevt_1_1term.html">vt::term</a></li>
                <li><a href="namespacevt_1_1vrt.html">vt::vrt</a></li>
              </ol>
            </li>
          </ol>
          <ol class="m-col-t-6 m-col-m-none" start="5">
            <li><a href="annotated.html">Classes</a></li>
            <li><a href="files.html">Files</a></li>
            <li>
              <a href="https://github.com/DARMA-tasking/vt">GitHub</a>
              <ol>
                <li><a href="https://github.com/DARMA-tasking/checkpoint">Checkpoint</a></li>
                <li><a href="https://github.com/DARMA-tasking/detector">Detector</a></li>
                <li><a href="https://github.com/DARMA-tasking/LB-analysis-framework">LBAF</a></li>
                <li><a href="https://github.com/DARMA-tasking/checkpoint-member-analyzer">Checkpoint Analyzer</a></li>
                <li><a href="https://github.com/DARMA-tasking/DARMA-tasking.github.io">Documentation</a></li>
              </ol>
            </li>
            <li class="m-show-m"><a href="#search" class="m-doc-search-icon" title="Search" onclick="return showSearch()"><svg style="height: 0.9rem;" viewBox="0 0 16 16">
              <use href="#m-doc-search-icon-path" />
            </svg></a></li>
          </ol>
        </div>
      </div>
    </div>
  </div>
</nav></header>
<main><article>
  <div class="m-container m-container-inflatable">
    <div class="m-row">
      <div class="m-col-l-10 m-push-l-1">
        <h1>
          <span class="m-breadcrumb"><a href="index.html">DARMA</a> &raquo;</span>
          <span class="m-breadcrumb"><a href="introduction.html">Introduction</a> &raquo;</span>
          Virtual Context Collection
        </h1>
<p>Collection of tasks</p><p>The virtual context collection component <code><a href="structvt_1_1vrt_1_1collection_1_1_collection_manager.html" class="m-doc">vt::<wbr />vrt::<wbr />collection::<wbr />CollectionManager</a></code>, accessed via <code><a href="namespacevt.html#a1c45ce63bfd2c327ff7d76a319a371d8" class="m-doc">vt::<wbr />theCollection()</a></code> is a core VT component that manages multi-dimensional collections of <em>virtual context</em> (or a migratable C++ object registered with <strong><em>vt</em></strong>) elements. It manages the creation, deletion, and messaging across elements at runtime supporting dense, sparse, on-demand, and staged insert modes. It utilizes the <a href="location.html" class="m-doc">Location Manager</a> to manage the location of these elements to efficiently deliver messages. It also utilizes the <a href="group.html" class="m-doc">Group Manager</a> to build a spanning tree across the nodes that the collection is currently mapped to. This group makes broadcasts efficient and allows reductions to make progress without waiting for nodes that do not have collection elements. The proc-stats component stores the statistics for live collections that then passes the instrumented data to the <a href="lb-manager.html" class="m-doc">LB Manager</a> component to apply load balancing strategies.</p><section id="rooted-hello-world-collection"><h2><a href="#rooted-hello-world-collection">Hello World 1D Dense Collection (Rooted)</a></h2><pre class="m-code"><span class="k">struct</span> <span class="nl">Hello</span> <span class="p">:</span> <span class="n">vt</span><span class="o">::</span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">Hello</span><span class="p">,</span> <span class="n">vt</span><span class="o">::</span><span class="n">Index1D</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="n">Hello</span><span class="p">()</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span>

  <span class="k">virtual</span> <span class="o">~</span><span class="n">Hello</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">vtAssert</span><span class="p">(</span><span class="n">counter_</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Must be equal&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">using</span> <span class="n">TestMsg</span> <span class="o">=</span> <span class="n">vt</span><span class="o">::</span><span class="n">CollectionMessage</span><span class="o">&lt;</span><span class="n">Hello</span><span class="o">&gt;</span><span class="p">;</span>

  <span class="kt">void</span> <span class="nf">doWork</span><span class="p">(</span><span class="n">TestMsg</span><span class="o">*</span> <span class="n">msg</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">fmt</span><span class="o">::</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;Hello from {}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">getIndex</span><span class="p">());</span>
    <span class="n">counter_</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
  <span class="kt">int32_t</span> <span class="n">counter_</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">vt</span><span class="o">::</span><span class="n">initialize</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>

  <span class="n">vt</span><span class="o">::</span><span class="n">NodeType</span> <span class="n">this_node</span> <span class="o">=</span> <span class="n">vt</span><span class="o">::</span><span class="n">theContext</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getNode</span><span class="p">();</span>

  <span class="kt">int</span> <span class="n">num_elms</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">num_elms</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">this_node</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">range</span> <span class="o">=</span> <span class="n">vt</span><span class="o">::</span><span class="n">Index1D</span><span class="p">(</span><span class="n">num_elms</span><span class="p">);</span>
    <span class="k">auto</span> <span class="n">proxy</span> <span class="o">=</span> <span class="n">vt</span><span class="o">::</span><span class="n">theCollection</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">construct</span><span class="o">&lt;</span><span class="n">Hello</span><span class="o">&gt;</span><span class="p">(</span><span class="n">range</span><span class="p">);</span>
    <span class="n">proxy</span><span class="p">.</span><span class="n">broadcast</span><span class="o">&lt;</span><span class="n">Hello</span><span class="o">::</span><span class="n">TestMsg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">Hello</span><span class="o">::</span><span class="n">doWork</span><span class="o">&gt;</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="n">vt</span><span class="o">::</span><span class="n">finalize</span><span class="p">();</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></pre></section><section id="collective-hello-world-collection"><h2><a href="#collective-hello-world-collection">Hello World 1D Dense Collection (Collective)</a></h2><pre class="m-code"><span class="k">struct</span> <span class="nl">Hello</span> <span class="p">:</span> <span class="n">vt</span><span class="o">::</span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">Hello</span><span class="p">,</span> <span class="n">vt</span><span class="o">::</span><span class="n">Index1D</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="n">Hello</span><span class="p">()</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span>

  <span class="k">virtual</span> <span class="o">~</span><span class="n">Hello</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">vt</span><span class="o">::</span><span class="n">NodeType</span> <span class="n">num_nodes</span> <span class="o">=</span> <span class="n">vt</span><span class="o">::</span><span class="n">theContext</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getNumNodes</span><span class="p">();</span>
    <span class="n">vtAssert</span><span class="p">(</span><span class="n">counter_</span> <span class="o">==</span> <span class="n">num_nodes</span><span class="p">,</span> <span class="s">&quot;Should receive # nodes broadcasts&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">using</span> <span class="n">TestMsg</span> <span class="o">=</span> <span class="n">vt</span><span class="o">::</span><span class="n">CollectionMessage</span><span class="o">&lt;</span><span class="n">Hello</span><span class="o">&gt;</span><span class="p">;</span>

  <span class="kt">void</span> <span class="nf">doWork</span><span class="p">(</span><span class="n">TestMsg</span><span class="o">*</span> <span class="n">msg</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">counter_</span><span class="o">++</span><span class="p">;</span>
    <span class="n">fmt</span><span class="o">::</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;Hello from {}, counter_={}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">getIndex</span><span class="p">().</span><span class="n">x</span><span class="p">(),</span> <span class="n">counter_</span><span class="p">);</span>
  <span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
  <span class="kt">int</span> <span class="n">counter_</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">vt</span><span class="o">::</span><span class="n">initialize</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>

  <span class="kt">int32_t</span> <span class="n">num_elms</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">num_elms</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="p">}</span>

  <span class="k">auto</span> <span class="n">range</span> <span class="o">=</span> <span class="n">vt</span><span class="o">::</span><span class="n">Index1D</span><span class="p">(</span><span class="n">num_elms</span><span class="p">);</span>
  <span class="k">auto</span> <span class="n">proxy</span> <span class="o">=</span> <span class="n">vt</span><span class="o">::</span><span class="n">theCollection</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">constructCollective</span><span class="o">&lt;</span><span class="n">Hello</span><span class="o">&gt;</span><span class="p">(</span><span class="n">range</span><span class="p">);</span>

  <span class="c1">// All nodes send a broadcast to all elements</span>
  <span class="n">proxy</span><span class="p">.</span><span class="n">broadcast</span><span class="o">&lt;</span><span class="n">Hello</span><span class="o">::</span><span class="n">TestMsg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">Hello</span><span class="o">::</span><span class="n">doWork</span><span class="o">&gt;</span><span class="p">();</span>

  <span class="n">vt</span><span class="o">::</span><span class="n">finalize</span><span class="p">();</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></pre></section><section id="reduce-hello-world-collection"><h2><a href="#reduce-hello-world-collection">Hello World 1D Collection Reduce</a></h2><pre class="m-code"><span class="k">struct</span> <span class="nl">Hello</span> <span class="p">:</span> <span class="n">vt</span><span class="o">::</span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">Hello</span><span class="p">,</span> <span class="n">vt</span><span class="o">::</span><span class="n">Index1D</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="k">using</span> <span class="n">ReduceMsg</span> <span class="o">=</span> <span class="n">vt</span><span class="o">::</span><span class="n">collective</span><span class="o">::</span><span class="n">ReduceTMsg</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">;</span>

  <span class="kt">void</span> <span class="nf">done</span><span class="p">(</span><span class="n">ReduceMsg</span><span class="o">*</span> <span class="n">msg</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">fmt</span><span class="o">::</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;Reduce complete at {} value {}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">getIndex</span><span class="p">(),</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">getVal</span><span class="p">());</span>
  <span class="p">}</span>

  <span class="k">using</span> <span class="n">TestMsg</span> <span class="o">=</span> <span class="n">vt</span><span class="o">::</span><span class="n">CollectionMessage</span><span class="o">&lt;</span><span class="n">Hello</span><span class="o">&gt;</span><span class="p">;</span>

  <span class="kt">void</span> <span class="nf">doWork</span><span class="p">(</span><span class="n">TestMsg</span><span class="o">*</span> <span class="n">msg</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">fmt</span><span class="o">::</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;Hello from {}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">getIndex</span><span class="p">());</span>

    <span class="c1">// Get the proxy for the collection</span>
    <span class="k">auto</span> <span class="n">proxy</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">getCollectionProxy</span><span class="p">();</span>

    <span class="c1">// Create a callback for when the reduction finishes</span>
    <span class="k">auto</span> <span class="n">cb</span> <span class="o">=</span> <span class="n">vt</span><span class="o">::</span><span class="n">theCB</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">makeSend</span><span class="o">&lt;</span><span class="n">Hello</span><span class="p">,</span><span class="n">ReduceMsg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">Hello</span><span class="o">::</span><span class="n">done</span><span class="o">&gt;</span><span class="p">(</span><span class="n">proxy</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>

    <span class="c1">// Create and send the reduction message holding an int</span>
    <span class="k">auto</span> <span class="n">red_msg</span> <span class="o">=</span> <span class="n">vt</span><span class="o">::</span><span class="n">makeMessage</span><span class="o">&lt;</span><span class="n">ReduceMsg</span><span class="o">&gt;</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">getIndex</span><span class="p">().</span><span class="n">x</span><span class="p">());</span>
    <span class="n">proxy</span><span class="p">.</span><span class="n">reduce</span><span class="o">&lt;</span><span class="n">vt</span><span class="o">::</span><span class="n">collective</span><span class="o">::</span><span class="n">PlusOp</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">red_msg</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span><span class="n">cb</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">vt</span><span class="o">::</span><span class="n">initialize</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>

  <span class="n">vt</span><span class="o">::</span><span class="n">NodeType</span> <span class="n">this_node</span> <span class="o">=</span> <span class="n">vt</span><span class="o">::</span><span class="n">theContext</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getNode</span><span class="p">();</span>

  <span class="kt">int32_t</span> <span class="n">num_elms</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">num_elms</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">this_node</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">range</span> <span class="o">=</span> <span class="n">vt</span><span class="o">::</span><span class="n">Index1D</span><span class="p">(</span><span class="n">num_elms</span><span class="p">);</span>
    <span class="k">auto</span> <span class="n">proxy</span> <span class="o">=</span> <span class="n">vt</span><span class="o">::</span><span class="n">theCollection</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">construct</span><span class="o">&lt;</span><span class="n">Hello</span><span class="o">&gt;</span><span class="p">(</span><span class="n">range</span><span class="p">);</span>
    <span class="n">proxy</span><span class="p">.</span><span class="n">broadcast</span><span class="o">&lt;</span><span class="n">Hello</span><span class="o">::</span><span class="n">TestMsg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">Hello</span><span class="o">::</span><span class="n">doWork</span><span class="o">&gt;</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="n">vt</span><span class="o">::</span><span class="n">finalize</span><span class="p">();</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></pre></section><section id="staged-insert-hello-world-collection"><h2><a href="#staged-insert-hello-world-collection">Hello World 1D Collection Staged Insert</a></h2><pre class="m-code"><span class="k">struct</span> <span class="nl">Hello</span> <span class="p">:</span> <span class="n">vt</span><span class="o">::</span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">Hello</span><span class="p">,</span> <span class="n">vt</span><span class="o">::</span><span class="n">Index1D</span><span class="o">&gt;</span> <span class="p">{</span>

  <span class="c1">// Default constructor for migration</span>
  <span class="n">Hello</span><span class="p">()</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span>

  <span class="c1">// Constructor used during insertion</span>
  <span class="k">explicit</span> <span class="nf">Hello</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">input_string</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">in</span><span class="p">(</span><span class="n">input_string</span><span class="p">)</span>
  <span class="p">{</span> <span class="p">}</span>

  <span class="k">virtual</span> <span class="o">~</span><span class="n">Hello</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">vtAssert</span><span class="p">(</span><span class="n">counter_</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Must be equal&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">using</span> <span class="n">TestMsg</span> <span class="o">=</span> <span class="n">vt</span><span class="o">::</span><span class="n">CollectionMessage</span><span class="o">&lt;</span><span class="n">Hello</span><span class="o">&gt;</span><span class="p">;</span>

  <span class="kt">void</span> <span class="nf">doWork</span><span class="p">(</span><span class="n">TestMsg</span><span class="o">*</span> <span class="n">msg</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">counter_</span><span class="o">++</span><span class="p">;</span>

    <span class="n">vt</span><span class="o">::</span><span class="n">NodeType</span> <span class="n">this_node</span> <span class="o">=</span> <span class="n">vt</span><span class="o">::</span><span class="n">theContext</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getNode</span><span class="p">();</span>
    <span class="n">fmt</span><span class="o">::</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;{}: Hello from {}: {}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">this_node</span><span class="p">,</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">getIndex</span><span class="p">(),</span> <span class="n">in</span><span class="p">);</span>
  <span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
  <span class="kt">int</span> <span class="n">counter_</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">in</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">vt</span><span class="o">::</span><span class="n">initialize</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>

  <span class="n">vt</span><span class="o">::</span><span class="n">NodeType</span> <span class="n">this_node</span> <span class="o">=</span> <span class="n">vt</span><span class="o">::</span><span class="n">theContext</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getNode</span><span class="p">();</span>
  <span class="n">vt</span><span class="o">::</span><span class="n">NodeType</span> <span class="n">num_nodes</span> <span class="o">=</span> <span class="n">vt</span><span class="o">::</span><span class="n">theContext</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getNumNodes</span><span class="p">();</span>

  <span class="kt">int</span> <span class="n">num_elms</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">num_elms</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="p">}</span>

  <span class="k">auto</span> <span class="n">range</span> <span class="o">=</span> <span class="n">vt</span><span class="o">::</span><span class="n">Index1D</span><span class="p">(</span><span class="n">num_elms</span><span class="p">);</span>
  <span class="k">auto</span> <span class="n">token</span> <span class="o">=</span> <span class="n">vt</span><span class="o">::</span><span class="n">theCollection</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">constructInsert</span><span class="o">&lt;</span><span class="n">Hello</span><span class="o">&gt;</span><span class="p">(</span><span class="n">range</span><span class="p">);</span>

  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_elms</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Insert even elements, round-robin the insertions from each node</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">%</span> <span class="n">num_nodes</span> <span class="o">==</span> <span class="n">this_node</span> <span class="n">and</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">auto</span> <span class="n">str</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">::</span><span class="n">format</span><span class="p">(</span><span class="s">&quot;inserted from {}&quot;</span><span class="p">,</span> <span class="n">this_node</span><span class="p">);</span>

      <span class="c1">// Construct the i&#39;th element on this node, passing str to the constructor</span>
      <span class="n">token</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">insert</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// Finish all inserts on this node by invalidating the insert token</span>
  <span class="k">auto</span> <span class="n">proxy</span> <span class="o">=</span> <span class="n">vt</span><span class="o">::</span><span class="n">theCollection</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">finishedInsert</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">token</span><span class="p">));</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">this_node</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">proxy</span><span class="p">.</span><span class="n">broadcast</span><span class="o">&lt;</span><span class="n">Hello</span><span class="o">::</span><span class="n">TestMsg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">Hello</span><span class="o">::</span><span class="n">doWork</span><span class="o">&gt;</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="n">vt</span><span class="o">::</span><span class="n">finalize</span><span class="p">();</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></pre></section>
      </div>
    </div>
  </div>
</article></main>
<div class="m-doc-search" id="search">
  <a href="#!" onclick="return hideSearch()"></a>
  <div class="m-container">
    <div class="m-row">
      <div class="m-col-m-8 m-push-m-2">
        <div class="m-doc-search-header m-text m-small">
          <div><span class="m-label m-default">Tab</span> / <span class="m-label m-default">T</span> to search, <span class="m-label m-default">Esc</span> to close</div>
          <div id="search-symbolcount">&hellip;</div>
        </div>
        <div class="m-doc-search-content">
          <form>
            <input type="search" name="q" id="search-input" placeholder="Loading &hellip;" disabled="disabled" autofocus="autofocus" autocomplete="off" spellcheck="false" />
          </form>
          <noscript class="m-text m-danger m-text-center">Unlike everything else in the docs, the search functionality <em>requires</em> JavaScript.</noscript>
          <div id="search-help" class="m-text m-dim m-text-center">
            <p class="m-noindent">Search for symbols, directories, files, pages or
            modules. You can omit any prefix from the symbol or file path; adding a
            <code>:</code> or <code>/</code> suffix lists all members of given symbol or
            directory.</p>
            <p class="m-noindent">Use <span class="m-label m-dim">&darr;</span>
            / <span class="m-label m-dim">&uarr;</span> to navigate through the list,
            <span class="m-label m-dim">Enter</span> to go.
            <span class="m-label m-dim">Tab</span> autocompletes common prefix, you can
            copy a link to the result using <span class="m-label m-dim">⌘</span>
            <span class="m-label m-dim">L</span> while <span class="m-label m-dim">⌘</span>
            <span class="m-label m-dim">M</span> produces a Markdown link.</p>
          </div>
          <div id="search-notfound" class="m-text m-warning m-text-center">Sorry, nothing was found.</div>
          <ul id="search-results"></ul>
        </div>
      </div>
    </div>
  </div>
</div>
<script src="search-v1.js"></script>
<script src="searchdata-v1.js" async="async"></script>
<footer><nav>
  <div class="m-container">
    <div class="m-row">
      <div class="m-col-l-10 m-push-l-1">
        <p>vt (Virtual Transport). Created with <a href="https://doxygen.org/">Doxygen</a> 1.8.13 and <a href="https://mcss.mosra.cz/">m.css</a>.</p>
      </div>
    </div>
  </div>
</nav></footer>
</body>
</html>
